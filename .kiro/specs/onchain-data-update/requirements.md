# Requirements Document

## Introduction

本ドキュメントは、JPYC Analytics Dashboard におけるオンチェーンデータ取得・表示機能の要件を定義します。本機能は、Ethereum、Polygon、Avalanche の3チェーンから JPYC の総供給量と保有者数をリアルタイムで取得し、ユーザーに分かりやすく可視化することを目的としています。

### ビジネス価値
- **透明性の向上**: オンチェーンデータを直接表示し、JPYC の信頼性を証明
- **マルチチェーン対応**: 各チェーンの状況を一元管理・可視化
- **パフォーマンス最適化**: RPC経由の直接取得とキャッシュ機構により API コストとレスポンス時間を削減

**注記**: 2025年10月の更新により、Moralis APIとScan API依存を削除し、RPC経由でのデータ取得に移行しました。保有者数の表示機能は削除され、総供給量とチェーン別分布のみをRPC経由で取得します。

---

## Requirements

### Requirement 1: マルチチェーン総供給量データ取得

**Objective:** データアナリストおよび JPYC 保有者として、Ethereum、Polygon、Avalanche の3チェーンにおける JPYC 総供給量の合計値を確認したい。これにより、JPYC エコシステム全体の規模を把握できる。

#### Acceptance Criteria

1. WHEN ダッシュボードが読み込まれる THEN システムは Ethereum、Polygon、Avalanche の各チェーンスキャン API から総供給量データを取得すること
2. WHEN 各チェーンからデータ取得が完了する THEN システムは3チェーン分の総供給量を合算し、合計値を表示すること
3. IF ブラックリストアドレスが設定されている THEN システムはブラックリストアドレスの保有分を合計値から差し引くこと
4. WHEN データ取得中である THEN システムはローディングインジケータを表示すること
5. IF データ取得エラーが発生する THEN システムはエラーメッセージを表示し、前回のキャッシュデータ（存在する場合）を表示すること

---

### Requirement 2: ~~マルチチェーン保有者数データ取得~~ (削除済み)

**Status:** ❌ **削除済み** - 2025年10月の更新により、保有者数機能は削除されました。RPC経由での保有者数取得はコスト効率が悪いため、本機能は対象外となります。

---

### Requirement 3: チェーン別総供給量可視化

**Objective:** データアナリストとして、各チェーン（Ethereum、Polygon、Avalanche）ごとの総供給量の分布を視覚的に把握したい。これにより、どのチェーンが最も活発かを理解できる。

#### Acceptance Criteria

1. WHEN ダッシュボードが読み込まれる THEN システムは各チェーンの総供給量を横棒グラフ形式で表示すること
2. WHERE グラフ表示エリア THE システムは**最も供給量が多いチェーンを100%**として、他のチェーンを相対的な割合で表示すること
3. WHEN グラフが表示される THEN 各バーには**絶対値（JPYC数量）と相対パーセンテージ**を併記すること
4. WHEN グラフが表示される THEN システムは最も数値が大きいチェーンを視覚的に強調表示すること
5. WHEN ユーザーがグラフにカーソルを合わせる THEN システムは詳細な数値（絶対値、パーセンテージ）をツールチップで表示すること

**実装例**: Ethereum 400M (100%)、Polygon 200M (50%)、Avalanche 100M (25%)

---

### Requirement 4: 現在価格表示（CoinGecko API 統合準備）

**Objective:** JPYC 保有者として、JPYC の現在価格を確認したい。ただし、CoinGecko API がまだ登録されていないため、現時点では準備段階の表示とする。

#### Acceptance Criteria

1. WHEN ダッシュボードが読み込まれる THEN システムは現在価格カードに "Coming Soon" メッセージを表示すること
2. WHERE 現在価格カード THE システムは "オンチェーン価格連携を準備中です" という説明文を表示すること
3. IF CoinGecko API キーが環境変数に設定されている THEN システムは CoinGecko API から価格データを取得し表示すること
4. WHEN CoinGecko API から価格データを取得する THEN システムは JPY 建ての価格を表示すること
5. IF CoinGecko API からエラーが返される THEN システムは "Coming Soon" 表示にフォールバックすること

---

### Requirement 5: TTL 付きローカル永続キャッシュ

**Objective:** システム管理者として、スキャン API への過剰なリクエストを防ぎ、コストとパフォーマンスを最適化したい。

#### Acceptance Criteria

1. WHEN オンチェーンデータを取得する THEN システムは取得したデータをローカルストレージに保存すること
2. WHERE ローカルストレージ THE システムは各データに30分の TTL（Time To Live）を設定すること
3. IF キャッシュが有効期限内である THEN システムは API リクエストを行わず、キャッシュからデータを返すこと
4. IF キャッシュが有効期限切れである THEN システムは API から新しいデータを取得し、キャッシュを更新すること
5. WHEN ブラウザのローカルストレージが利用できない THEN システムはメモリキャッシュにフォールバックすること
6. IF ローカルストレージの容量上限に達する THEN システムは最も古いキャッシュエントリを削除すること

---

### Requirement 6: SWR（Stale-While-Revalidate）パターン実装

**Objective:** エンドユーザーとして、データ更新中でも古いデータ（Stale Data）をすぐに表示し、更新が完了したら自動的に最新データに切り替わる UX を体験したい。

#### Acceptance Criteria

1. WHEN ページが読み込まれる AND キャッシュデータが存在する THEN システムは即座にキャッシュデータを表示すること
2. WHILE キャッシュデータを表示している THE システムはバックグラウンドで最新データを取得すること
3. WHEN バックグラウンドでのデータ取得が完了する THEN システムは表示を最新データに更新すること
4. IF バックグラウンドでのデータ取得がエラーになる THEN システムはキャッシュデータの表示を維持し、エラー通知を表示すること
5. WHERE データが更新される THE システムはスムーズなトランジション効果を適用すること

---

### Requirement 7: ブラックリストアドレス管理

**Objective:** システム管理者として、特定のアドレス（運営保有分など）を集計から除外することで、実際の流通量と保有者数を正確に表示したい。

#### Acceptance Criteria

1. WHERE アプリケーション設定 THE システムはブラックリストアドレスを環境変数または設定ファイルで管理すること
2. WHEN 総供給量を計算する THEN システムはブラックリストアドレスの保有残高を各チェーンの総供給量から減算すること
3. WHEN 保有者数を計算する THEN システムはブラックリストアドレスを保有者数カウントから除外すること
4. IF ブラックリストアドレスが複数設定されている THEN システムはすべてのブラックリストアドレスを処理すること
5. IF ブラックリストアドレスが設定されていない THEN システムは生のオンチェーンデータをそのまま表示すること

---

### Requirement 8: API レート制限対応

**Objective:** システム管理者として、スキャン API のレート制限を遵守し、サービスの安定稼働を維持したい。

#### Acceptance Criteria

1. WHEN スキャン API にリクエストを送信する THEN システムは各 API のレート制限（リクエスト/秒、リクエスト/日）を遵守すること
2. IF API レート制限エラー（429 Too Many Requests）を受信する THEN システムは指数バックオフでリトライすること
3. WHEN 複数チェーンのデータを取得する THEN システムは並列リクエストではなく、適切な遅延を挟んで順次リクエストを送信すること
4. WHERE キャッシュが有効である THE システムは最大でも30分に1回のデータ取得に制限すること
5. IF リトライが規定回数失敗する THEN システムはエラーログを記録し、キャッシュデータまたはエラー表示にフォールバックすること

---

### Requirement 9: エラーハンドリングとフォールバック

**Objective:** エンドユーザーとして、一部の API がエラーになった場合でも、利用可能なデータは表示され、エラーが明確に通知されることを期待する。

#### Acceptance Criteria

1. IF Ethereum チェーンのデータ取得が失敗する THEN システムは Polygon と Avalanche のデータのみを表示し、Ethereum がエラーであることを通知すること
2. IF すべてのチェーンでデータ取得が失敗する THEN システムはキャッシュデータ（存在する場合）を表示し、エラーメッセージを表示すること
3. WHEN API エラーが発生する THEN システムはエラーの種類（ネットワークエラー、タイムアウト、レート制限など）を判別し、適切なメッセージを表示すること
4. IF キャッシュもデータも利用できない THEN システムは "データ取得に失敗しました。しばらくしてから再試行してください" というメッセージを表示すること
5. WHERE エラー通知 THE システムは非侵襲的な通知（トースト通知など）でユーザーに知らせること

---

### Requirement 10: パフォーマンス要件

**Objective:** エンドユーザーとして、ダッシュボードの初回ロード時間が3秒以内で、データ更新が体感的に高速であることを期待する。

#### Acceptance Criteria

1. WHEN ページが初回読み込みされる AND キャッシュが存在しない THEN システムは3秒以内にファーストペイント（First Paint）を完了すること
2. WHEN ページが初回読み込みされる AND キャッシュが存在する THEN システムは1秒以内にキャッシュデータを表示すること
3. WHEN バックグラウンドでデータを更新する THEN システムは5秒以内に更新を完了すること
4. IF データ取得が5秒を超える THEN システムはタイムアウトし、キャッシュデータまたはエラー表示にフォールバックすること
5. WHERE データ表示エリア THE システムは React.memo や useMemo を活用して不要な再レンダリングを防ぐこと

---

## Non-Functional Requirements

### セキュリティ要件
- API キーは環境変数で管理し、クライアントサイドに露出させない（可能な限り）
- ブラックリストアドレスは設定ファイルで管理し、バージョン管理対象とする

### 可用性要件
- キャッシュ機構により、API ダウン時でも過去データを表示可能
- エラー発生時も部分的なデータ表示を維持

### 保守性要件
- チェーン追加時の拡張性を考慮した設計
- 各チェーンのデータ取得ロジックをモジュール化

### 互換性要件
- localStorage 対応ブラウザ（Chrome、Firefox、Safari、Edge の最新版）
- モバイルブラウザ（iOS Safari、Chrome Mobile）

---

## Out of Scope（本要件の対象外）

以下は本要件の対象外とします：
- CoinGecko API の完全統合（準備段階のみ）
- ヒストリカルデータの保存と表示
- ユーザー認証機能
- バックエンド API の実装（フロントエンドのみ）
- リアルタイムデータストリーミング（ポーリングベース）
